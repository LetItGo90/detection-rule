name: Deploy Elastic Detection Rules

on:
  workflow_dispatch:
  push:
    paths:
      - 'elastic-rules/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Deploy Rules to Elastic SIEM
        env:
          ELASTIC_URL: ${{ secrets.ELASTIC_KIBANA_URL }}
          ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import requests
          from pathlib import Path
          
          elastic_url = os.environ.get('ELASTIC_URL', '').rstrip('/')
          api_key = os.environ.get('ELASTIC_API_KEY', '')
          
          if not elastic_url or not api_key:
              print('âŒ Missing credentials')
              exit(1)
          
          headers = {
              'Authorization': f'ApiKey {api_key}',
              'kbn-xsrf': 'true',
              'Content-Type': 'application/json'
          }
          
          for rule_file in Path('elastic-rules').rglob('*.json'):
              print(f'\nðŸ“„ {rule_file.name}')
              
              with open(rule_file) as f:
                  rule = json.load(f)
              
              response = requests.post(
                  f'{elastic_url}/api/detection_engine/rules',
                  headers=headers,
                  json=rule
              )
              
              if response.status_code in [200, 201]:
                  print(f'   âœ… Deployed')
              elif response.status_code == 409:
                  print(f'   âš ï¸  Already exists')
              else:
                  print(f'   âŒ {response.status_code}: {response.text[:200]}')
          EOF