name: Convert Sigma to Elastic Query DSL

on:
  workflow_dispatch:
  push:
    paths:
      - 'sigma-rules/**'
    branches:
      - main

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install sigma-cli pysigma-backend-elasticsearch requests pyyaml
      
      - name: Convert Sigma to Elasticsearch Query DSL
        run: |
          mkdir -p elastic-rules/windows
          for file in sigma-rules/**/*.yml; do
            sigma convert -t elasticsearch -f dsl_lucene "$file" > "elastic-rules/windows/$(basename ${file%.yml}.json)" 2>&1 || echo "Failed: $file"
          done
      
      - name: Commit to GitHub
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --hard origin/main
          
          mkdir -p elastic-rules/windows
          for file in sigma-rules/**/*.yml; do
            sigma convert -t elasticsearch -f dsl_lucene "$file" > "elastic-rules/windows/$(basename ${file%.yml}.json)" 2>&1 || echo "Failed: $file"
          done
          
          git add elastic-rules/
          git diff --staged --quiet || git commit -m "Auto-convert Sigma rules [skip ci]"
          git push origin main
      
      - name: Deploy to Elastic SIEM
        env:
          ELASTIC_URL: ${{ secrets.ELASTIC_KIBANA_URL }}
          ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
        run: |
          echo "ELASTIC_URL is set: ${ELASTIC_URL:+yes}"
          echo "ELASTIC_API_KEY is set: ${ELASTIC_API_KEY:+yes}"
          python3 << 'EOF'
          import os
          import requests
          import json
          from pathlib import Path
          
          elastic_url = os.environ.get('ELASTIC_URL', '')
          api_key = os.environ.get('ELASTIC_API_KEY', '')
          
          if not elastic_url:
              print('❌ ELASTIC_URL is not set!')
              exit(1)
          
          if not api_key:
              print('❌ ELASTIC_API_KEY is not set!')
              exit(1)
          
          elastic_url = elastic_url.rstrip('/')
          
          print(f'Using Elastic URL: {elastic_url[:30]}...')
          
          headers = {
              'Authorization': f'ApiKey {api_key}',
              'kbn-xsrf': 'true',
              'Content-Type': 'application/json'
          }
          
          for query_file in Path('elastic-rules').rglob('*.json'):
              with open(query_file) as f:
                  content = f.read().strip()
              
              if not content or 'Failed:' in content or 'Traceback' in content:
                  print(f'⚠️  Skipping invalid: {query_file.name}')
                  continue
              
              try:
                  query_obj = json.loads(content)
              except:
                  print(f'⚠️  Skipping non-JSON: {query_file.name}')
                  continue
              
              rule_name = query_file.stem.replace('-', ' ').replace('_', ' ').title()
              
              rule = {
                  'name': rule_name,
                  'description': f'Auto-converted from Sigma: {query_file.stem}',
                  'type': 'query',
                  'language': 'lucene',
                  'query': query_obj,
                  'risk_score': 50,
                  'severity': 'medium',
                  'enabled': False,
                  'interval': '5m',
                  'from': 'now-6m',
                  'index': ['logs-*', 'winlogbeat-*', 'filebeat-*', 'endgame-*']
              }
              
              response = requests.post(
                  f'{elastic_url}/api/detection_engine/rules',
                  headers=headers,
                  json=rule
              )
              
              if response.status_code in [200, 201]:
                  print(f'✅ {query_file.name}')
              else:
                  print(f'❌ {query_file.name}')
                  print(f'   HTTP {response.status_code}')
                  print(f'   {response.text[:200]}')
          EOF