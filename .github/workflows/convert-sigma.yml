name: Convert Sigma to Elastic EQL

on:
  push:
    paths:
      - 'sigma-rules/**'

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install sigma-cli pysigma-backend-elasticsearch requests pyyaml
      
      - name: Convert Sigma to EQL
        run: |
          mkdir -p elastic-rules
          for file in sigma-rules/*.yml; do
            sigma convert -t elasticsearch -f eql "$file" > "elastic-rules/$(basename ${file%.yml}.eql)"
          done
      
      - name: Push to Elastic SIEM
        env:
          ELASTIC_URL: ${{ secrets.ELASTIC_URL }}
          ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import requests
          from pathlib import Path

          elastic_url = os.environ['ELASTIC_URL']
          api_key = os.environ['ELASTIC_API_KEY']
          
          headers = {
              'Authorization': f'ApiKey {api_key}',
              'kbn-xsrf': 'true',
              'Content-Type': 'application/json'
          }
          
          for eql_file in Path('elastic-rules').glob('*.eql'):
              with open(eql_file) as f:
                  query = f.read().strip()
              
              rule_data = {
                  'name': eql_file.stem,
                  'description': f'Auto-converted from Sigma: {eql_file.stem}',
                  'type': 'eql',
                  'language': 'eql',
                  'query': query,
                  'risk_score': 50,
                  'severity': 'medium',
                  'enabled': True
              }
              
              response = requests.post(
                  f'{elastic_url}/api/detection_engine/rules',
                  headers=headers,
                  json=rule_data
              )
              
              if response.status_code in [200, 201]:
                  print(f'âœ… Imported: {eql_file.name}')
              else:
                  print(f'âŒ Failed: {eql_file.name} - {response.text}')
          EOF
      
      - name: Commit converted rules
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull origin main --rebase  # ðŸ‘ˆ ADD THIS LINE
          git add elastic-rules/
          git diff --staged --quiet || git commit -m "Auto-convert Sigma rules [skip ci]"
          git push